<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>减肥健康平台</title>
  <link rel="stylesheet" href="./css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <header>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container">
        <a class="navbar-brand" href="#">减肥健康平台</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileNav" aria-controls="mobileNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="d-none d-lg-block ms-auto">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <button id="homeBtnDesktop" class="btn btn-outline-primary nav-link active">主页</button>
            </li>
            <li class="nav-item">
              <button id="gameBtnDesktop" class="btn btn-outline-primary nav-link">小游戏</button>
            </li>
            <li class="nav-item">
              <button id="page2BtnDesktop" class="btn btn-outline-primary nav-link">营养指南</button>
            </li>
            <li class="nav-item">
              <button id="page3BtnDesktop" class="btn btn-outline-primary nav-link">居家健身计划</button>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <div class="offcanvas offcanvas-end" tabindex="-1" id="mobileNav" aria-labelledby="mobileNavLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="mobileNavLabel">导航</h5>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body">
        <ul class="navbar-nav">
          <li class="nav-item mb-2">
            <button id="homeBtn" class="btn btn-outline-primary nav-link w-100">主页</button>
          </li>
          <li class="nav-item mb-2">
            <button id="gameBtn" class="btn btn-outline-primary nav-link w-100">小游戏</button>
          </li>
          <li class="nav-item mb-2">
            <button id="page2Btn" class="btn btn-outline-primary nav-link w-100">营养指南</button>
          </li>
          <li class="nav-item">
            <button id="page3Btn" class="btn btn-outline-primary nav-link w-100">居家健身计划</button>
          </li>
        </ul>
      </div>
    </div>
  </header>

  <main class="container-fluid">
    <div class="row">
      <div class="col-md-9">
        <div id="homeContent">
          <section id="weightLossCarousel" class="carousel slide mb-4" data-bs-ride="carousel">
            <div class="carousel-indicators">
              <button type="button" data-bs-target="#weightLossCarousel" data-bs-slide-to="0" class="active"></button>
              <button type="button" data-bs-target="#weightLossCarousel" data-bs-slide-to="1"></button>
              <button type="button" data-bs-target="#weightLossCarousel" data-bs-slide-to="2"></button>
            </div>
            <div class="carousel-inner">
              <div class="carousel-item active">
                <img src="https://picsum.photos/seed/weightloss1/800/400.jpg" class="d-block w-100" alt="减肥科普1">
                <div class="carousel-caption d-none d-md-block">
                  <h5>科学饮食减肥</h5>
                  <p>了解如何通过合理饮食实现健康减肥</p>
                </div>
              </div>
              <div class="carousel-item">
                <img src="https://picsum.photos/seed/weightloss2/800/400.jpg" class="d-block w-100" alt="减肥科普2">
                <div class="carousel-caption d-none d-md-block">
                  <h5>有氧运动燃脂</h5>
                  <p>高效运动，加速脂肪燃烧</p>
                </div>
              </div>
              <div class="carousel-item">
                <img src="https://picsum.photos/seed/weightloss3/800/400.jpg" class="d-block w-100" alt="减肥科普3">
                <div class="carousel-caption d-none d-md-block">
                  <h5>健康生活方式</h5>
                  <p>养成良好习惯，保持理想体重</p>
                </div>
              </div>
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#weightLossCarousel" data-bs-slide="prev">
              <span class="carousel-control-prev-icon"></span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#weightLossCarousel" data-bs-slide="next">
              <span class="carousel-control-next-icon"></span>
            </button>
          </section>

          <section class="mb-4">
            <h2 class="mb-3">最新减肥资讯</h2>
            <div id="weightLossNews" class="row">
              <div class="col-md-12 text-center py-3">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">加载中...</span>
                </div>
                <p class="mt-2">正在获取最新减肥资讯...</p>
              </div>
            </div>
          </section>
        </div>

        <div id="gameContent" class="d-none">
          <div id="cameraGameContainer">
            <div class="card rounded-2xl p-4 mb-4">
              <div class="row g-3">
                <div class="col-md-4">
                  <div class="mb-3">
                    <label class="form-label">摄像头状态</label>
                    <div id="cameraStatus" class="camera-status camera-disconnected">未连接</div>
                    <button id="connectCameraBtn" class="btn btn-primary w-100 mt-2">连接摄像头</button>
                    <button id="switchCameraBtn" class="btn btn-outline-primary w-100 mt-2" disabled>切换摄像头</button>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="mb-3">
                    <label class="form-label">体重设置</label>
                    <div class="d-flex align-items-center gap-3">
                      <span class="text-muted">40kg</span>
                      <input type="range" id="weightSlider" min="40" max="120" value="60" class="form-range">
                      <span class="text-muted">120kg</span>
                    </div>
                    <div class="text-center mt-2">
                      <span id="weightDisplay" class="fw-bold text-primary">60</span>
                      <span>kg</span>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="mb-3">
                    <label class="form-label">训练设置</label>
                    <button id="openSetupWizardBtn" class="btn btn-outline-primary w-100 py-3">
                      <i class="fas fa-sliders-h me-2"></i>自定义训练计划
                    </button>
                    <div class="mt-2 text-center text-muted small" id="currentPlanSummary">
                      默认模式: 5分钟全身训练
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Training Setup Wizard Modal -->
            <div id="setupWizardModal" class="modal-overlay d-none">
              <div class="card rounded-2xl p-0" style="max-width: 600px; width: 95%; max-height: 90vh; overflow: hidden;">
                <div class="card-header bg-white border-bottom p-3">
                  <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold text-primary">定制训练计划</h5>
                    <button id="closeWizardBtn" class="btn-close"></button>
                  </div>
                  <div class="wizard-steps mt-3 d-flex justify-content-between position-relative">
                    <div class="progress position-absolute top-50 start-0 w-100 translate-middle-y" style="height: 2px; z-index: 0;">
                      <div class="progress-bar" id="wizardProgressBar" style="width: 0%"></div>
                    </div>
                    <button class="btn btn-sm btn-primary rounded-circle position-relative z-1 wizard-step-btn active" data-step="1">1</button>
                    <button class="btn btn-sm btn-secondary rounded-circle position-relative z-1 wizard-step-btn" data-step="2">2</button>
                    <button class="btn btn-sm btn-secondary rounded-circle position-relative z-1 wizard-step-btn" data-step="3">3</button>
                  </div>
                  <div class="d-flex justify-content-between mt-1 text-muted small">
                    <span>时长</span>
                    <span>动作</span>
                    <span>开始</span>
                  </div>
                </div>
                
                <div class="card-body overflow-auto p-4" id="wizardContent" style="min-height: 300px;">
                  <!-- Step 1: Duration -->
                  <div class="wizard-step" id="step1">
                    <h5 class="mb-4 text-center">选择训练时长</h5>
                    <div class="row g-3 mb-4">
                      <div class="col-6"><button class="btn btn-outline-primary w-100 py-3 time-preset" data-time="300">5 分钟</button></div>
                      <div class="col-6"><button class="btn btn-outline-primary w-100 py-3 time-preset" data-time="600">10 分钟</button></div>
                      <div class="col-6"><button class="btn btn-outline-primary w-100 py-3 time-preset" data-time="900">15 分钟</button></div>
                      <div class="col-6"><button class="btn btn-outline-primary w-100 py-3 time-preset" data-time="1800">30 分钟</button></div>
                    </div>
                    <div class="input-group mb-3">
                      <span class="input-group-text">自定义(秒)</span>
                      <input type="number" id="customTimeInput" class="form-control" placeholder="例如: 120" min="60">
                      <button class="btn btn-outline-secondary" type="button" id="applyCustomTimeBtn">确认</button>
                    </div>
                    <div class="text-center mt-4">
                       <div class="display-4 fw-bold text-primary" id="selectedTimeDisplay">05:00</div>
                       <p class="text-muted">预计消耗 <span id="estCalories">40</span> kcal</p>
                    </div>
                  </div>

                  <!-- Step 2: Actions -->
                  <div class="wizard-step d-none" id="step2">
                    <h5 class="mb-3">选择训练动作</h5>
                    <ul class="nav nav-pills nav-fill mb-3" id="actionCategoryTabs">
                      <li class="nav-item"><a class="nav-link active" data-cat="all" href="#">全部</a></li>
                      <li class="nav-item"><a class="nav-link" data-cat="upper" href="#">上肢</a></li>
                      <li class="nav-item"><a class="nav-link" data-cat="lower" href="#">下肢</a></li>
                      <li class="nav-item"><a class="nav-link" data-cat="core" href="#">核心</a></li>
                    </ul>
                    <div class="action-grid row g-2" id="actionSelectionGrid" style="max-height: 300px; overflow-y: auto;">
                      <!-- Actions injected by JS -->
                    </div>
                    <div class="mt-3 p-2 bg-light rounded">
                      <small class="text-muted">已选动作 (<span id="selectedActionCount">0</span>):</small>
                      <div id="selectedActionTags" class="d-flex flex-wrap gap-1 mt-1"></div>
                    </div>
                  </div>

                  <!-- Step 3: Preview -->
                  <div class="wizard-step d-none" id="step3">
                    <h5 class="text-center mb-4">准备开始</h5>
                    <div class="card bg-light border-0 mb-3">
                      <div class="card-body text-center">
                        <h2 class="text-primary fw-bold" id="finalTimeDisplay">05:00</h2>
                        <p class="mb-0">总计 <span id="finalActionCount">5</span> 个动作</p>
                      </div>
                    </div>
                    <div class="alert alert-info d-flex align-items-center">
                      <i class="fas fa-volume-up me-3 fs-4"></i>
                      <div>
                        <strong>语音提示已开启</strong>
                        <br><small>训练过程中将有语音指导和动作倒计时</small>
                      </div>
                    </div>
                    <div class="alert alert-warning d-flex align-items-center">
                      <i class="fas fa-video me-3 fs-4"></i>
                      <div>
                        <strong>请确保全身入镜</strong>
                        <br><small>距离摄像头约 2-3 米</small>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="card-footer bg-white p-3 d-flex justify-content-between">
                  <button class="btn btn-secondary" id="wizardPrevBtn" disabled>上一步</button>
                  <button class="btn btn-primary" id="wizardNextBtn">下一步</button>
                </div>
              </div>
            </div>

            <div class="row g-3 mb-4">
              <div class="col-lg-3">
                <div class="card rounded-2xl p-4">
                  <div class="text-center mb-4">
                    <div class="position-relative mx-auto mb-2" style="width:80px;height:80px;">
                      <svg class="progress-ring" width="80" height="80">
                        <circle cx="40" cy="40" r="35" stroke="rgba(0, 212, 255, 0.2)" stroke-width="4" fill="none"></circle>
                        <circle id="progressCircle" cx="40" cy="40" r="35" stroke="#00d4ff" stroke-width="4" fill="none" class="progress-ring-circle"></circle>
                      </svg>
                      <div class="position-absolute top-50 start-50 translate-middle">
                        <span id="countdownDisplay" class="fw-bold">300</span>
                      </div>
                    </div>
                    <div class="text-muted small">剩余时间</div>
                  </div>
                  <div class="text-center mb-3">
                    <div class="fw-bold text-primary mb-1"><span id="currentRound">1</span>/<span id="totalRounds">5</span></div>
                    <div class="text-muted small">当前轮次</div>
                  </div>
                  <div class="text-center">
                    <div id="currentPhase" class="fw-semibold text-success mb-1">准备开始</div>
                    <div class="text-muted small">训练状态</div>
                  </div>
                </div>
                <div class="card rounded-2xl p-4 mt-3">
                  <div class="d-grid gap-2">
                    <button id="startBtn" class="btn btn-primary" disabled>开始训练</button>
                    <button id="pauseBtn" class="btn btn-outline-primary" disabled>暂停</button>
                    <button id="endBtn" class="btn btn-danger" disabled>结束训练</button>
                  </div>
                </div>
              </div>
              <div class="col-lg-6">
                <div class="card rounded-2xl p-4">
                  <div class="video-container position-relative">
                    <video id="video" autoplay muted playsinline style="width:100%;transform:scaleX(-1);"></video>
                    <canvas id="skeletonCanvas" class="skeleton-overlay"></canvas>
                    <div id="actionGuide" class="action-guide hidden">
                      <div class="text-center">
                        <img id="currentActionIcon" src="/fitness_game/squat-icon.png" alt="当前动作" class="opacity-0" style="width:64px;height:64px;">
                        <h3 id="currentActionName" class="fw-bold text-primary mb-2">深蹲</h3>
                        <p id="actionInstruction" class="text-muted small">请站直身体，准备开始</p>
                        <div id="rhythmBar" class="mt-2 bg-light rounded opacity-0" style="height:6px;">
                          <div id="rhythmPointer" class="bg-primary rounded" style="height:6px;width:4px;"></div>
                        </div>
                      </div>
                    </div>
                    <div id="calibrationOverlay" class="calibration-overlay hidden">
                      <div class="calibration-step">
                        <h2 class="fw-bold text-primary mb-3">摄像头校准</h2>
                        <p class="mb-3">请确保您的完整身体在摄像头范围内</p>
                        <div class="mx-auto mb-3" style="width:128px;height:192px;border:2px dashed #0dcaf0;border-radius:8px;display:flex;align-items:center;justify-content:center;">
                          <span class="text-primary">站在这里</span>
                        </div>
                        <button id="completeCalibrationBtn" class="btn btn-primary">完成校准</button>
                      </div>
                    </div>
                    <div id="cameraStatusIndicator" class="camera-status camera-disconnected">摄像头未连接</div>
                  </div>
                </div>
              </div>
              <div class="col-lg-3">
                <div class="card rounded-2xl p-4">
                  <div class="text-center mb-3">
                    <div id="scoreDisplay" class="fw-bold text-warning">0</div>
                    <div class="text-muted small">总分</div>
                  </div>
                  <div class="text-center mb-3">
                    <div class="fw-bold text-muted mb-1"><span id="comboCount">0</span>连击</div>
                    <div class="text-muted small">倍数: <span id="comboMultiplier" class="text-primary">1.0x</span></div>
                  </div>
                  <div class="text-center">
                    <div id="caloriesDisplay" class="fw-bold text-danger">0</div>
                    <div class="text-muted small">卡路里</div>
                  </div>
                  <div class="text-center mt-3">
                    <div class="fw-bold text-success mb-1"><span id="todayHighScore">0</span></div>
                    <div class="text-muted small">今日最高分</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="row g-3 mb-4">
              <div class="col-lg-6">
                <div class="card rounded-2xl p-4">
                  <h3 class="text-center">今日排行榜</h3>
                  <div id="todayLeaderboard" class="space-y-2"></div>
                </div>
              </div>
              <div class="col-lg-6">
                <div class="card rounded-2xl p-4">
                  <h3 class="text-center">历史排行榜</h3>
                  <div id="historyLeaderboard" class="space-y-2"></div>
                </div>
              </div>
            </div>

            <div class="card rounded-2xl p-4 mt-3">
              <h3 class="mb-3">动作与游戏要求</h3>
              <div class="row g-3">
                <div class="col-lg-6">
                  <h5 class="mb-2">训练模式</h5>
                  <div id="modeDesc" class="text-muted">30s动作 + 30s休息 × 5轮</div>
                  <ul class="list-group mt-2">
                    <li class="list-group-item">完成动作获得分数与连击</li>
                    <li class="list-group-item">完美命中提供更高倍率</li>
                    <li class="list-group-item">休息阶段不计分</li>
                  </ul>
                </div>
                <div class="col-lg-6">
                  <h5 class="mb-2">动作列表</h5>
                  <div id="actionsList" class="list-group"></div>
                </div>
              </div>
            </div>

            <div id="gameOverModal" class="modal-overlay d-none">
              <div class="card rounded-2xl p-4" style="max-width:480px;width:100%;">
                <div class="text-center">
                  <h2 class="fw-bold text-primary mb-3">训练完成</h2>
                  <div class="mb-3">
                    <div class="d-flex justify-content-between"><span>最终得分：</span><span id="finalScore" class="fw-bold text-warning">0</span></div>
                    <div class="d-flex justify-content-between"><span>最高连击：</span><span id="maxCombo" class="fw-bold text-muted">0</span></div>
                    <div class="d-flex justify-content-between"><span>消耗卡路里：</span><span id="totalCalories" class="fw-bold text-danger">0</span></div>
                    <div class="d-flex justify-content-between"><span>准确率：</span><span id="accuracy" class="fw-bold text-success">0%</span></div>
                  </div>
                  <div class="d-grid gap-2">
                    <button id="playAgainBtn" class="btn btn-primary">再来一次</button>
                    <button id="viewRankBtn" class="btn btn-outline-primary">查看排行</button>
                    <button id="consultGameAiBtn" class="btn btn-outline-info">
                      <i class="fas fa-user-md me-1"></i>获取恢复建议
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div id="errorModal" class="modal-overlay d-none">
              <div class="card rounded-2xl p-4" style="max-width:480px;width:100%;">
                <div class="text-center">
                  <div class="mb-2">⚠️</div>
                  <h2 class="fw-bold text-danger mb-2">错误</h2>
                  <p id="errorMessage" class="text-muted mb-3">发生了一个错误</p>
                  <button id="closeErrorBtn" class="btn btn-primary">确定</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="page2Content" class="d-none">
          <h2 class="mb-3">营养指南</h2>
        </div>

        <div id="page3Content" class="d-none">
          <h2 class="mb-3">居家健身计划</h2>
        </div>

        <div id="newsDetailContent" class="d-none">
          <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h2 class="mb-0">资讯详情</h2>
              <button id="backToHomeBtn" class="btn btn-outline-secondary btn-sm">返回主页</button>
            </div>
            <div class="card-body" id="newsDetailBody"></div>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="calendar-widget card mb-4">
          <div class="card-header">
            <h5 class="mb-0">日历</h5>
          </div>
          <div class="card-body">
            <div id="calendar"></div>
          </div>
        </div>

        <div class="weight-loss-tips card">
          <div class="card-header">
            <h5 class="mb-0">减肥小贴士</h5>
          </div>
          <div class="card-body">
            <ul class="list-unstyled">
              <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>每天保持8杯水的饮水量</li>
              <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>每天至少运动30分钟</li>
              <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>控制每日热量摄入</li>
              <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>多吃蔬菜水果，少吃油腻食物</li>
              <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>保持规律的作息时间</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="bg-light text-center py-3 mt-5">
    <p>&copy; 2023 减肥健康平台. 保留所有权利.</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="./js/app.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1675469404/pose.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3.1640029074/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.3.1620248257/drawing_utils.js"></script>
  <script src="/fitness_game/camera-stabilizer.js"></script>
  <script src="/fitness_game/camera-game-final.js"></script>
  <script src="./js/analytics.js"></script>
  <script src="https://lf-cdn.coze.cn/obj/unpkg/flow-platform/chat-app-sdk/1.2.0-beta.19/libs/cn/index.js"></script>
  <script>
    (async function(){
      var sid = localStorage.getItem('ut_sid') || (Date.now().toString(36)+Math.random().toString(36).slice(2));
      localStorage.setItem('ut_sid', sid);
      async function fetchToken(){
        try{
          var res = await fetch('/api/coze/token', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ sessionName: sid }) });
          var j = await res.json();
          return j && j.access_token ? j.access_token : '';
        }catch(e){ return ''; }
      }
      var initialToken = await fetchToken();
      if (!initialToken){
        console.warn('Coze token missing: please ensure private_key.pem exists and OAuth settings are correct');
        alert('The access token is missing. Please check server configuration (private_key.pem, appId, keyId).');
        return;
      }
      window.cozeClient = new CozeWebSDK.WebChatClient({
        config: { bot_id: '7567998337488863274' },
        componentProps: { title: 'Coze' },
        auth: { type: 'token', token: initialToken, onRefreshToken: fetchToken }
      });

      var overlay = document.getElementById('coze-overlay');
      if (!overlay){
        overlay = document.createElement('div');
        overlay.id = 'coze-overlay';
        overlay.style.position = 'fixed';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.width = '100%';
        overlay.style.height = '100%';
        overlay.style.zIndex = '2147483647';
        overlay.style.pointerEvents = 'none';
        document.body.appendChild(overlay);
      }
      function bumpCoze(){
        var nodes = Array.from(document.querySelectorAll('*'));
        nodes.forEach(function(n){
          var id = n.id || '';
          var cls = n.className || '';
          if ((typeof cls === 'string' && cls.toLowerCase().includes('coze')) || (typeof id === 'string' && id.toLowerCase().includes('coze'))){
            try { n.style.zIndex = '2147483647'; } catch(e){}
          }
        });
      }
      var mo = new MutationObserver(bumpCoze);
      mo.observe(document.body, {childList:true, subtree:true, attributes:true});
      bumpCoze();
    })();
  </script>
</body>
</html>
