<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>使用性统计仪表盘</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container">
      <a class="navbar-brand" href="/">减肥健康平台</a>
      <div class="ms-auto">
        <a class="btn btn-outline-primary" href="/">返回首页</a>
      </div>
    </div>
  </nav>
  <main class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="h4 m-0">使用性统计仪表盘</h1>
      <div class="btn-group">
        <button id="refreshBtn" class="btn btn-primary">刷新</button>
        <a id="downloadRawBtn" class="btn btn-outline-secondary" href="#">下载原始事件</a>
      </div>
    </div>
    <div class="row g-3">
      <div class="col-md-4">
        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between"><span>会话数</span><span id="sessions" class="fw-bold">0</span></div>
            <div class="d-flex justify-content-between"><span>错误次数</span><span id="errors" class="fw-bold">0</span></div>
          </div>
        </div>
      </div>
      <div class="col-md-8">
        <div class="card">
          <div class="card-body">
            <h2 class="h6">任务摘要</h2>
            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead><tr><th>任务</th><th>开始</th><th>完成</th><th>完成率</th><th>平均用时(ms)</th></tr></thead>
                <tbody id="summaryBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="card mt-3">
      <div class="card-body">
        <h2 class="h6">点击热图</h2>
        <canvas id="heatmap" width="800" height="600" class="border rounded w-100" style="max-height:600px"></canvas>
      </div>
    </div>
    <div class="card mt-3">
      <div class="card-body">
        <h2 class="h6">原始事件预览</h2>
        <pre id="rawPreview" class="small" style="max-height:240px;overflow:auto"></pre>
      </div>
    </div>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    async function loadSummary(){
      try{ const res = await fetch('/api/ux-summary'); const j = await res.json(); if(!j.success) return; document.getElementById('sessions').textContent = j.data.sessions; document.getElementById('errors').textContent = j.data.errors; const body = document.getElementById('summaryBody'); body.innerHTML = j.data.summary.map(function(r){ return '<tr><td>'+r.id+'</td><td>'+r.starts+'</td><td>'+r.ends+'</td><td>'+r.completionRate+'%</td><td>'+r.averageMs+'</td></tr>'; }).join(''); } catch(e){} }
    async function loadHeat(){
      try{ const res = await fetch('/api/ux-heatmap'); const j = await res.json(); if(!j.success) return; const cvs = document.getElementById('heatmap'); const ctx = cvs.getContext('2d'); ctx.clearRect(0,0,cvs.width,cvs.height); const cell = 40; const max = Math.max(1, ...Object.values(j.data)); Object.keys(j.data).forEach(function(k){ var parts = k.split(':'); var gx = parseInt(parts[0]); var gy = parseInt(parts[1]); var v = j.data[k]; var a = Math.min(1, 0.15 + v/max); ctx.fillStyle = 'rgba(255,0,0,'+a+')'; ctx.fillRect(gx*cell, gy*cell, cell, cell); }); ctx.strokeStyle = 'rgba(0,0,0,0.1)'; for(var x=0;x<cvs.width;x+=cell){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,cvs.height); ctx.stroke(); } for(var y=0;y<cvs.height;y+=cell){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(cvs.width,y); ctx.stroke(); }
      } catch(e){} }
    async function loadRaw(){ try{ const res = await fetch('/api/ux-events/raw?limit=300'); const txt = await res.text(); document.getElementById('rawPreview').textContent = txt; } catch(e){} }
    document.getElementById('refreshBtn').addEventListener('click', function(){ loadSummary(); loadHeat(); loadRaw(); });
    document.getElementById('downloadRawBtn').addEventListener('click', async function(ev){ ev.preventDefault(); try{ const res = await fetch('/api/ux-events/raw'); const txt = await res.text(); const blob = new Blob([txt], { type: 'text/plain' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'ux-events.jsonl'; a.click(); URL.revokeObjectURL(url); } catch(e){} });
    loadSummary(); loadHeat(); loadRaw();
  </script>
</body>
</html>
